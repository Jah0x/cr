import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'

const storageKey = 'language'
const supportedLanguages = ['ru', 'en'] as const

type SupportedLanguage = (typeof supportedLanguages)[number]

const detectInitialLanguage = (): SupportedLanguage => {
  const stored = localStorage.getItem(storageKey)
  if (stored && supportedLanguages.includes(stored as SupportedLanguage)) {
    return stored as SupportedLanguage
  }

  const browserLanguages = navigator.languages ?? [navigator.language]
  const normalized = browserLanguages.map((lang) => lang.toLowerCase())
  if (normalized.some((lang) => lang.startsWith('ru'))) {
    return 'ru'
  }
  if (normalized.some((lang) => lang.startsWith('en'))) {
    return 'en'
  }
  return 'ru'
}

const resources = {
  en: {
    translation: {
      language: {
        label: 'Language',
        ru: 'Russian',
        en: 'English'
      },
      nav: {
        platform: 'Platform',
        tenants: 'Tenants',
        tenantConsole: 'Tenant Console',
        admin: 'Admin',
        pos: 'POS',
        finance: 'Finance',
        settings: 'Settings'
      },
      common: {
        add: 'Add',
        save: 'Save',
        saving: 'Saving...',
        cancel: 'Cancel',
        create: 'Create',
        loading: 'Loading...',
        retry: 'Retry',
        yes: 'Yes',
        no: 'No',
        status: 'Status',
        schema: 'Schema',
        revision: 'Revision',
        head: 'Head',
        primary: 'Primary',
        remove: 'Remove',
        copy: 'Copy',
        copied: 'Copied',
        email: 'Email',
        password: 'Password',
        created: 'Created',
        updated: 'Updated',
        deleted: 'Deleted',
        delete: 'Delete',
        confirmDelete: 'Delete this item?',
        saved: 'Saved',
        error: 'Something went wrong'
      },
      errors: {
        loginFailed: 'Login failed',
        requestTimeout: 'Request timed out. Please try again.',
        requestCancelled: 'Request was cancelled. Please try again.',
        invalidPlatformCredentials: 'Invalid platform credentials.',
        inviteInvalid: 'Invite is invalid or expired.',
        inviteNotFound: 'Invite not found. Ask an admin to create a new one.',
        inviteExpired: 'Invite has expired. Create a new invite.',
        inviteTenantMismatch: 'Invite is for another tenant. Open the domain from the email.',
        inviteNetwork: 'Unable to reach the server. Check /api routing.',
        inviteTokenRequired: 'Invite token is required.',
        inviteTokenMissing: 'Invite link is missing a token.',
        passwordLength: 'Password must be at least 8 characters.',
        passwordMismatch: 'Passwords do not match.',
        registrationFailed: 'Unable to complete registration.',
        loadTenantsFailed: 'Unable to load tenants.',
        loadTenantSettingsFailed: 'Unable to load tenant settings.',
        loadTenantSettingsMessage: 'Failed to load tenant settings.',
        finalizeSaleFailed: 'Unable to finalize sale.',
        createTenantFailed: 'Unable to create tenant.',
        addItemsBeforeFinalize: 'Add items to the cart before finalizing.'
      },
      login: {
        title: 'Login',
        signIn: 'Sign in',
        emailPlaceholder: 'Email',
        passwordPlaceholder: 'Password'
      },
      register: {
        title: 'Complete registration',
        invitedEmail: 'Invited email',
        inviteTokenPlaceholder: 'Invite token',
        passwordPlaceholder: 'Password',
        confirmPasswordPlaceholder: 'Confirm password',
        setPassword: 'Set password'
      },
      platformLogin: {
        title: 'Platform Access',
        subtitle: 'Sign in with the platform owner credentials.',
        signIn: 'Sign in'
      },
      admin: {
        title: 'Admin',
        catalog: 'Catalog',
        catalogSubtitle: 'Step-by-step catalog setup',
        catalogCategoryTitle: 'Category',
        catalogBrandTitle: 'Brand',
        catalogLinkTitle: 'Brand to category link',
        catalogLineTitle: 'Product line',
        catalogProductTitle: 'Product',
        categoryPlaceholder: 'Category',
        addCategory: 'Add Category',
        brandPlaceholder: 'Brand',
        addBrand: 'Add Brand',
        linePlaceholder: 'Line',
        addLine: 'Add Line',
        brandSelect: 'Brand',
        categorySelect: 'Category',
        lineSelect: 'Line',
        skuPlaceholder: 'SKU',
        barcodePlaceholder: 'Barcode',
        productPlaceholder: 'Product',
        productImageLabel: 'Product image URL',
        productImagePlaceholder: 'https://example.com/photo.jpg',
        productImageUpload: 'Upload image',
        productImagePreview: 'Product image preview',
        clearImage: 'Clear image',
        unitLabel: 'Unit',
        purchasePriceLabel: 'Cost price',
        purchasePricePlaceholder: 'Purchase price',
        sellPriceLabel: 'Retail price',
        sellPricePlaceholder: 'Sell price',
        addProduct: 'Add Product',
        linkBrand: 'Link brand',
        unlinkBrand: 'Unlink',
        linkBrandModalTitle: 'Link brand to category',
        searchBrandPlaceholder: 'Search brand',
        emptyCategories: 'No categories yet.',
        emptyBrands: 'No brands yet.',
        emptyLines: 'No lines yet.',
        emptyCategoryBrands: 'No linked brands.',
        emptyLinkedBrands: 'No brands linked yet.',
        emptyAvailableBrands: 'No brands available.',
        emptyProducts: 'No products yet.',
        selectCategoryToLink: 'Select a category to see linked brands.',
        unitPcs: 'pcs',
        unitMl: 'ml',
        unitG: 'g',
        table: {
          image: 'Image',
          name: 'Name',
          brand: 'Brand',
          brands: 'Brands',
          actions: 'Actions',
          sku: 'SKU',
          category: 'Category',
          line: 'Line',
          unit: 'Unit',
          purchasePrice: 'Purchase price',
          sellPrice: 'Sell price'
        },
        validation: {
          requiredFields: 'Fill in all required fields.',
          selectBrandForLine: 'Select a brand to create a product line.',
          nonNegative: 'Values must be zero or above.'
        },
        errors: {
          alreadyExists: 'Already exists.'
        },
        suppliersPurchasing: 'Suppliers & Purchasing',
        supplierPlaceholder: 'Supplier',
        addSupplier: 'Add Supplier',
        newInvoice: 'New Invoice',
        workingInvoice: 'Working invoice {{id}}',
        productSelect: 'Product',
        qtyPlaceholder: 'Qty',
        costPlaceholder: 'Cost',
        addItem: 'Add Item',
        postInvoice: 'Post Invoice',
        stock: 'Stock',
        adjust: 'Adjust',
        stockLevels: 'Stock Levels',
        reports: 'Reports',
        loadSummary: 'Load Summary',
        totalSales: 'Total sales',
        totalPurchases: 'Total purchases',
        grossMargin: 'Gross margin'
      },
      pos: {
        title: 'POS',
        subtitle: 'Quick sales, flexible payments, and tax-aware totals.',
        searchProducts: 'Search products',
        noImage: 'No image',
        cart: 'Cart',
        emptyCart: 'No items in cart',
        subtotal: 'Subtotal',
        tax: 'Tax',
        payments: 'Payments',
        amount: 'Amount',
        reference: 'Reference',
        addPayment: 'Add',
        due: 'Due',
        finalize: 'Finalize Sale',
        sale: 'Sale',
        status: 'Status',
        total: 'Total',
        remove: 'Remove',
        paymentMethodCash: 'Cash',
        paymentMethodCard: 'Card',
        paymentMethodExternal: 'External'
      },
      finance: {
        title: 'Finance',
        expenseCategories: 'Expense Categories',
        categoryName: 'Category name',
        addCategory: 'Add Category',
        logExpense: 'Log Expense',
        amount: 'Amount',
        category: 'Category',
        paymentMethod: 'Payment method',
        note: 'Note',
        saveExpense: 'Save Expense',
        pnlSummary: 'P&L Summary',
        today: 'Today',
        week: 'Week',
        month: 'Month',
        totalSales: 'Total sales',
        cogs: 'COGS',
        grossProfit: 'Gross profit',
        expenses: 'Expenses',
        netProfit: 'Net profit',
        expensesTitle: 'Expenses',
        noNote: 'No note'
      },
      settings: {
        loading: 'Loading settings...',
        noSettings: 'No settings available.',
        title: 'Tenant settings',
        subtitle: 'Manage enabled modules, feature flags, and UI preferences.',
        modules: 'Modules',
        features: 'Features',
        uiPreferences: 'UI preferences',
        inactive: 'inactive',
        compactNav: 'Compact navigation',
        showHelp: 'Show help tips',
        errorTitle: 'Unable to load tenant settings.',
        taxesTitle: 'Taxes',
        taxesSubtitle: 'Configure flexible tax rules for the checkout.',
        taxesEnabled: 'Enable tax calculation',
        taxesMode: 'Calculation mode',
        taxesModeExclusive: 'Add tax on top',
        taxesModeInclusive: 'Tax included in prices',
        taxesRounding: 'Rounding',
        taxesRoundingRound: 'Standard rounding',
        taxesRoundingCeil: 'Always round up',
        taxesRoundingFloor: 'Always round down',
        taxRuleName: 'Tax name',
        taxRuleRate: 'Rate (%)',
        taxRuleStatus: 'Status',
        taxRuleActions: 'Actions',
        taxRuleEmpty: 'No tax rules yet.',
        taxRuleNamePlaceholder: 'Tax label',
        taxRuleRatePlaceholder: 'Rate',
        addTaxRule: 'Add tax rule',
        taxRuleActive: 'Active',
        taxRuleInactive: 'Inactive',
        taxRuleValidation: 'Enter a name and a valid rate.'
      },
      platformTenants: {
        title: 'Tenants',
        createTenant: 'Create tenant',
        loading: 'Loading tenants...',
        codeLabel: 'Code',
        migrateTenant: 'Migrate tenant',
        migrating: 'Migrating...',
        tenantName: 'Tenant name',
        tenantCode: 'Tenant code',
        tenantCodeReadOnly: 'Tenant code cannot be edited.',
        statusActive: 'active',
        statusInactive: 'inactive',
        schemaExists: 'Schema exists',
        lastError: 'Last error',
        domains: 'Domains',
        addDomain: 'Add domain',
        inviteLink: 'Invite link',
        generateInvite: 'Generate invite',
        expires: 'Expires',
        invites: 'Invitations',
        inviteEmail: 'Email',
        inviteCreated: 'Created',
        inviteExpires: 'Expires',
        inviteUsed: 'Used',
        regenerateInvite: 'Generate new invite',
        deleteInvite: 'Delete invite',
        deleteInviteConfirm: 'Delete this invite?',
        noInvites: 'No invites yet.',
        users: 'Users',
        deactivate: 'Deactivate',
        activate: 'Activate',
        deleteUserConfirm: 'Delete this user?',
        delete: 'Delete',
        userEmail: 'user email',
        rolesPlaceholder: 'roles (comma separated)',
        passwordMode: 'Password',
        inviteMode: 'Invite',
        passwordPlaceholder: 'password',
        createInvite: 'Create invite',
        addUser: 'Add user',
        domainPlaceholder: 'domain.example.com',
        inviteEmailPlaceholder: 'email@example.com',
        rolePlaceholder: 'role'
      },
      platformTenantCreate: {
        title: 'Create tenant',
        tenantName: 'Tenant name',
        tenantCode: 'Tenant code',
        ownerEmail: 'Owner email',
        templateId: 'Template id (optional)',
        tenantUrl: 'Tenant URL',
        inviteUrl: 'Invite URL'
      }
    }
  },
  ru: {
    translation: {
      language: {
        label: 'Язык',
        ru: 'Русский',
        en: 'Английский'
      },
      nav: {
        platform: 'Платформа',
        tenants: 'Тенанты',
        tenantConsole: 'Консоль арендатора',
        admin: 'Админ',
        pos: 'Касса',
        finance: 'Финансы',
        settings: 'Настройки'
      },
      common: {
        add: 'Добавить',
        save: 'Сохранить',
        saving: 'Сохранение...',
        cancel: 'Отмена',
        create: 'Создать',
        loading: 'Загрузка...',
        retry: 'Повторить',
        yes: 'Да',
        no: 'Нет',
        status: 'Статус',
        schema: 'Схема',
        revision: 'Ревизия',
        head: 'Head',
        primary: 'Основной',
        remove: 'Удалить',
        copy: 'Копировать',
        copied: 'Скопировано',
        email: 'Email',
        password: 'Пароль',
        created: 'Создано',
        updated: 'Обновлено',
        deleted: 'Удалено',
        delete: 'Удалить',
        confirmDelete: 'Удалить этот элемент?',
        saved: 'Сохранено',
        error: 'Что-то пошло не так'
      },
      errors: {
        loginFailed: 'Не удалось войти',
        requestTimeout: 'Время запроса истекло. Попробуйте снова.',
        requestCancelled: 'Запрос был отменен. Попробуйте снова.',
        invalidPlatformCredentials: 'Неверные платформенные учетные данные.',
        inviteInvalid: 'Приглашение недействительно или просрочено.',
        inviteNotFound: 'Приглашение не найдено. Попросите администратора создать новое.',
        inviteExpired: 'Истек срок. Создайте новое приглашение.',
        inviteTenantMismatch: 'Ссылка от другого тенанта. Откройте домен из письма.',
        inviteNetwork: 'Не удалось связаться с сервером. Проверьте /api роутинг.',
        inviteTokenRequired: 'Требуется токен приглашения.',
        inviteTokenMissing: 'В ссылке приглашения нет токена.',
        passwordLength: 'Пароль должен быть не короче 8 символов.',
        passwordMismatch: 'Пароли не совпадают.',
        registrationFailed: 'Не удалось завершить регистрацию.',
        loadTenantsFailed: 'Не удалось загрузить список тенантов.',
        loadTenantSettingsFailed: 'Не удалось загрузить настройки тенанта.',
        loadTenantSettingsMessage: 'Не удалось загрузить настройки тенанта.',
        finalizeSaleFailed: 'Не удалось завершить продажу.',
        createTenantFailed: 'Не удалось создать тенанта.',
        addItemsBeforeFinalize: 'Добавьте товары в корзину перед завершением.'
      },
      login: {
        title: 'Вход',
        signIn: 'Войти',
        emailPlaceholder: 'Email',
        passwordPlaceholder: 'Пароль'
      },
      register: {
        title: 'Завершение регистрации',
        invitedEmail: 'Приглашенный email',
        inviteTokenPlaceholder: 'Токен приглашения',
        passwordPlaceholder: 'Пароль',
        confirmPasswordPlaceholder: 'Подтвердите пароль',
        setPassword: 'Установить пароль'
      },
      platformLogin: {
        title: 'Доступ к платформе',
        subtitle: 'Войдите с учетными данными владельца платформы.',
        signIn: 'Войти'
      },
      admin: {
        title: 'Админ',
        catalog: 'Каталог',
        catalogSubtitle: 'Пошаговое создание каталога',
        catalogCategoryTitle: 'Категория',
        catalogBrandTitle: 'Бренд',
        catalogLinkTitle: 'Привязка бренда к категории',
        catalogLineTitle: 'Линейка',
        catalogProductTitle: 'Товар',
        categoryPlaceholder: 'Категория',
        addCategory: 'Добавить категорию',
        brandPlaceholder: 'Бренд',
        addBrand: 'Добавить бренд',
        linePlaceholder: 'Линейка',
        addLine: 'Добавить линейку',
        brandSelect: 'Бренд',
        categorySelect: 'Категория',
        lineSelect: 'Линейка',
        skuPlaceholder: 'SKU',
        barcodePlaceholder: 'Штрихкод',
        productPlaceholder: 'Товар',
        productImageLabel: 'Ссылка на фото',
        productImagePlaceholder: 'https://example.com/photo.jpg',
        productImageUpload: 'Загрузить фото',
        productImagePreview: 'Предпросмотр фото',
        clearImage: 'Очистить фото',
        unitLabel: 'Ед. измерения',
        purchasePriceLabel: 'Себестоимость',
        purchasePricePlaceholder: 'Закупка',
        sellPriceLabel: 'Розничная цена',
        sellPricePlaceholder: 'Продажа',
        addProduct: 'Добавить товар',
        linkBrand: 'Привязать бренд',
        unlinkBrand: 'Отвязать',
        linkBrandModalTitle: 'Привязка бренда к категории',
        searchBrandPlaceholder: 'Поиск бренда',
        emptyCategories: 'Категории отсутствуют.',
        emptyBrands: 'Бренды отсутствуют.',
        emptyLines: 'Линейки отсутствуют.',
        emptyCategoryBrands: 'Нет привязанных брендов.',
        emptyLinkedBrands: 'Нет привязанных брендов.',
        emptyAvailableBrands: 'Нет доступных брендов.',
        emptyProducts: 'Товары отсутствуют.',
        selectCategoryToLink: 'Выберите категорию для просмотра связей.',
        unitPcs: 'шт.',
        unitMl: 'мл',
        unitG: 'г',
        table: {
          image: 'Фото',
          name: 'Название',
          brand: 'Бренд',
          brands: 'Бренды',
          actions: 'Действия',
          sku: 'SKU',
          category: 'Категория',
          line: 'Линейка',
          unit: 'Ед.',
          purchasePrice: 'Закупка',
          sellPrice: 'Продажа'
        },
        validation: {
          requiredFields: 'Заполните обязательные поля.',
          selectBrandForLine: 'Выберите бренд для создания линейки.',
          nonNegative: 'Значения должны быть не меньше 0.'
        },
        errors: {
          alreadyExists: 'Уже существует.'
        },
        suppliersPurchasing: 'Поставщики и закупки',
        supplierPlaceholder: 'Поставщик',
        addSupplier: 'Добавить поставщика',
        newInvoice: 'Новая накладная',
        workingInvoice: 'Текущая накладная {{id}}',
        productSelect: 'Товар',
        qtyPlaceholder: 'Кол-во',
        costPlaceholder: 'Себестоимость',
        addItem: 'Добавить позицию',
        postInvoice: 'Провести накладную',
        stock: 'Склад',
        adjust: 'Корректировать',
        stockLevels: 'Остатки',
        reports: 'Отчеты',
        loadSummary: 'Загрузить сводку',
        totalSales: 'Продажи',
        totalPurchases: 'Закупки',
        grossMargin: 'Валовая маржа'
      },
      pos: {
        title: 'Касса',
        subtitle: 'Быстрые продажи, гибкие оплаты и налоги в расчетах.',
        searchProducts: 'Поиск товаров',
        noImage: 'Нет фото',
        cart: 'Корзина',
        emptyCart: 'Корзина пуста',
        subtotal: 'Подытог',
        tax: 'Налог',
        payments: 'Оплаты',
        amount: 'Сумма',
        reference: 'Комментарий',
        addPayment: 'Добавить',
        due: 'К оплате',
        finalize: 'Завершить продажу',
        sale: 'Продажа',
        status: 'Статус',
        total: 'Итого',
        remove: 'Удалить',
        paymentMethodCash: 'Наличные',
        paymentMethodCard: 'Карта',
        paymentMethodExternal: 'Внешний'
      },
      finance: {
        title: 'Финансы',
        expenseCategories: 'Категории расходов',
        categoryName: 'Название категории',
        addCategory: 'Добавить категорию',
        logExpense: 'Записать расход',
        amount: 'Сумма',
        category: 'Категория',
        paymentMethod: 'Способ оплаты',
        note: 'Комментарий',
        saveExpense: 'Сохранить расход',
        pnlSummary: 'Отчет о прибылях и убытках',
        today: 'Сегодня',
        week: 'Неделя',
        month: 'Месяц',
        totalSales: 'Продажи',
        cogs: 'Себестоимость',
        grossProfit: 'Валовая прибыль',
        expenses: 'Расходы',
        netProfit: 'Чистая прибыль',
        expensesTitle: 'Расходы',
        noNote: 'Без комментария'
      },
      settings: {
        loading: 'Загрузка настроек...',
        noSettings: 'Настройки недоступны.',
        title: 'Настройки тенанта',
        subtitle: 'Управляйте модулями, фичами и настройками интерфейса.',
        modules: 'Модули',
        features: 'Функции',
        uiPreferences: 'Предпочтения интерфейса',
        inactive: 'неактивен',
        compactNav: 'Компактная навигация',
        showHelp: 'Показывать подсказки',
        errorTitle: 'Не удалось загрузить настройки тенанта.',
        taxesTitle: 'Налоги',
        taxesSubtitle: 'Настройте гибкие правила расчета налогов для кассы.',
        taxesEnabled: 'Включить расчет налогов',
        taxesMode: 'Режим расчета',
        taxesModeExclusive: 'Начислять сверху',
        taxesModeInclusive: 'Включено в цену',
        taxesRounding: 'Округление',
        taxesRoundingRound: 'Стандартное округление',
        taxesRoundingCeil: 'Всегда вверх',
        taxesRoundingFloor: 'Всегда вниз',
        taxRuleName: 'Название',
        taxRuleRate: 'Ставка (%)',
        taxRuleStatus: 'Статус',
        taxRuleActions: 'Действия',
        taxRuleEmpty: 'Правила налогов отсутствуют.',
        taxRuleNamePlaceholder: 'Название налога',
        taxRuleRatePlaceholder: 'Ставка',
        addTaxRule: 'Добавить налог',
        taxRuleActive: 'Активен',
        taxRuleInactive: 'Неактивен',
        taxRuleValidation: 'Введите название и корректную ставку.'
      },
      platformTenants: {
        title: 'Тенанты',
        createTenant: 'Создать тенанта',
        loading: 'Загрузка тенантов...',
        codeLabel: 'Код',
        migrateTenant: 'Мигрировать тенанта',
        migrating: 'Миграция...',
        tenantName: 'Название тенанта',
        tenantCode: 'Код тенанта',
        tenantCodeReadOnly: 'Код тенанта нельзя редактировать.',
        statusActive: 'активен',
        statusInactive: 'неактивен',
        schemaExists: 'Схема существует',
        lastError: 'Последняя ошибка',
        domains: 'Домены',
        addDomain: 'Добавить домен',
        inviteLink: 'Ссылка приглашения',
        generateInvite: 'Создать приглашение',
        expires: 'Истекает',
        invites: 'Приглашения',
        inviteEmail: 'Email',
        inviteCreated: 'Создано',
        inviteExpires: 'Истекает',
        inviteUsed: 'Использовано',
        regenerateInvite: 'Сгенерировать новое приглашение',
        deleteInvite: 'Удалить приглашение',
        deleteInviteConfirm: 'Удалить это приглашение?',
        noInvites: 'Приглашений пока нет.',
        users: 'Пользователи',
        deactivate: 'Деактивировать',
        activate: 'Активировать',
        deleteUserConfirm: 'Удалить этого пользователя?',
        delete: 'Удалить',
        userEmail: 'email пользователя',
        rolesPlaceholder: 'роли (через запятую)',
        passwordMode: 'Пароль',
        inviteMode: 'Приглашение',
        passwordPlaceholder: 'пароль',
        createInvite: 'Создать приглашение',
        addUser: 'Добавить пользователя',
        domainPlaceholder: 'domain.example.com',
        inviteEmailPlaceholder: 'email@example.com',
        rolePlaceholder: 'роль'
      },
      platformTenantCreate: {
        title: 'Создание тенанта',
        tenantName: 'Название тенанта',
        tenantCode: 'Код тенанта',
        ownerEmail: 'Email владельца',
        templateId: 'ID шаблона (опционально)',
        tenantUrl: 'URL тенанта',
        inviteUrl: 'URL приглашения'
      }
    }
  }
}

i18n.use(initReactI18next).init({
  resources,
  lng: detectInitialLanguage(),
  fallbackLng: 'ru',
  interpolation: {
    escapeValue: false
  }
})

i18n.on('languageChanged', (language) => {
  localStorage.setItem(storageKey, language)
})

export default i18n
